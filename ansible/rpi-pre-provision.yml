---
- name: RPis pre-provisioning (local)
  hosts: rpi_local
  become: true
  gather_facts: true
  vars:
    pkgs:
      - net-tools
      - network-manager
  tasks:
    - name: Get default authorized_keys file content
      ansible.builtin.slurp:
        src: /home/izzy/.ssh/authorized_keys
      register: authorized_keys_content

    - name: Set root authorized_keys from default user
      ansible.posix.authorized_key:
        user: root
        key: "{{ authorized_keys_content['content'] | b64decode }}"
        state: present
        exclusive: true

    - name: Install needed packages
      ansible.builtin.apt:
        pkg: "{{ pkgs }}"
        state: present
        update_cache: true

    - name: Run local dig command to find new IP
      ansible.builtin.command: "dig +short {{ inventory_hostname_short }}.{{ global_domain }}"
      delegate_to: localhost
      become: false
      register: dig_output
      changed_when: false

    - name: Set new, fixed IP via nmcli
      community.general.nmcli:
        conn_name: "eth0"
        type: ethernet
        ifname: eth0
        ip4: "{{ dig_output.stdout }}/24"
        gw4: "{{ ansible_default_ipv4.gateway }}"
        dns4: "{{ dns_external_servers }}"
        state: present

    - name: Disable DHCP IP addresses in netplan
      ansible.builtin.replace:
        path: /etc/netplan/50-cloud-init.yaml
        regexp: "{{ item.find }}"
        replace: "{{ item.replace }}"
      loop:
        - { find: '(\s+)dhcp4\:(\s+)true(\s+.*)?$', replace: '\1dhcp4:\2false\3' }
        - { find: '(\s+)dhcp6\:(\s+)true(\s+.*)?$', replace: '\1dhcp6:\2false\3' }

    - name: Set new DNS servers
      ansible.builtin.replace:
        path: /etc/systemd/resolved.conf
        regexp: "{{ item.find }}"
        replace: "{{ item.replace }}"
      loop:
        - { find: '^#DNS=', replace: "DNS={{ dns_external_servers[0]}}" }
        - { find: '^#FallbackDNS=', replace: "FallbackDNS={{ dns_external_servers[1] }}" }

    - name: Set hostname
      ansible.builtin.hostname:
        name: "{{ inventory_hostname_short }}.{{ global_domain }}"

    # - name: Reboot RPi + may lose connection
    #   ansible.builtin.reboot:
    #     post_reboot_delay: 60
    #     reboot_timeout: 180
